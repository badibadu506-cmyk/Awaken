<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2113.65">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'; min-height: 15.0px}
    span.s1 {font: 13.0px 'Apple Color Emoji'}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html lang="de"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta charset="utf-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;title&gt;Atemintervall Wachelfreund&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>:root {</p>
<p class="p1"><span class="Apple-converted-space">      </span>--bg:#0b0c10; --fg:#e6f0ff; --muted:#96a2b4; --accent:#6ae3ff; --ok:#68e385; --warn:#ffd36a; --bad:#ff7a7a;</p>
<p class="p1"><span class="Apple-converted-space">      </span>--card:#131722; --btn:#1f2533; --btnhi:#2a3144;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>html,body {margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.45 -apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.wrap {max-width:680px;margin:0 auto;padding:24px 16px 80px;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>h1 {font-size:1.25rem;margin:0 0 12px;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.card {background:var(--card);border:1px solid #0003;border-radius:14px;padding:16px;margin:12px 0;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>label {display:block;color:var(--muted);font-size:.9rem;margin:6px 0 4px;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>input,select {width:100%;padding:12px;border-radius:12px;border:1px solid #0005;background:var(--btn);color:var(--fg);}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.row {display:grid;gap:10px;grid-template-columns:1fr 1fr;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.btnbar {display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>button {flex:1; padding:14px 16px; border:0; border-radius:14px; background:var(--btn); color:var(--fg); font-weight:600;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>button.primary {background:var(--btnhi);}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.pill {display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid #0005;background:#ffffff07;color:var(--fg);font-size:.9rem;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.muted {color:var(--muted);}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.grid3 {display:grid; gap:10px; grid-template-columns:repeat(4,1fr);}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.stat {background:#ffffff08; border:1px solid #0005; border-radius:12px; padding:10px; text-align:center;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.stat .v {font-size:1.15rem; font-weight:700;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.led {width:10px;height:10px;border-radius:50%;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.led.ok{background:var(--ok);} .led.warn{background:var(--warn);} .led.bad{background:var(--bad);}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.log {font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.85rem; white-space:pre-wrap; max-height:140px; overflow:auto; opacity:.9;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.banner {padding:12px;border-radius:12px;margin:10px 0;border:1px solid #0005;background:#ffffff06}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.blink {animation: blink 1s linear infinite;}</p>
<p class="p1"><span class="Apple-converted-space">    </span>@keyframes blink { 50% { opacity:.2 } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1">&lt;div class="wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;h1&gt;<span class="s1">🫁</span> Atemintervall – sanfter Wächter&lt;/h1&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="pattern"&gt;Atemmuster&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;select id="pattern"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="4-4-4-4"&gt;4–4–4–4 (Box breathing)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="4-0-6-0"&gt;4–0–6–0&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="5-5-5-5"&gt;5–5–5–5&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="6-0-6-0"&gt;6–0–6–0&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="custom"&gt;Benutzerdefiniert…&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="custom"&gt;Benutzerdefiniert (inhalt–halt–aus–halt, s)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input id="custom" type="text" value="4-4-4-4" disabled /&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="tolerance"&gt;Toleranz (s starke Abweichung bis Alarm)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input id="tolerance" type="range" min="2" max="8" step="0.5" value="4" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="muted"&gt;&lt;span id="tolLabel"&gt;4.0&lt;/span&gt; s&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="deviation"&gt;Abweichungsschwelle (stark)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input id="deviation" type="range" min="0.1" max="0.6" step="0.05" value="0.3" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="muted"&gt;±&lt;span id="devLabel"&gt;30&lt;/span&gt;% von Soll&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="sensitivity"&gt;Empfindlichkeit (Bewegung)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input id="sensitivity" type="range" min="0.5" max="3" step="0.1" value="1.4" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="muted"&gt;Höher = reagiert schneller&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label for="volume"&gt;Alarm-Lautstärke&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;input id="volume" type="range" min="0" max="1" step="0.05" value="0.25" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="muted"&gt;sanftes Fade-In&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="perm" class="pill"&gt;<span class="s1">📱</span> Sensor-Freigabe&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="sound" class="pill"&gt;<span class="s1">🔊</span> Audio aktivieren&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="wake" class="pill"&gt;<span class="s1">🌙</span> Bildschirm wach halten&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="start" class="primary"&gt;<span class="s1">▶️</span> Start&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="stop"&gt;<span class="s1">⏹️</span> Stop&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="calibrate"&gt;<span class="s1">🧭</span> Kalibrieren&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="banner"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>Lege das iPhone **flach** auf die Bauchdecke (Display nach oben). Atme 1–2 Zyklen im gewählten Muster, dann „Start“.</p>
<p class="p1"><span class="Apple-converted-space">      </span>Bei starker Abweichung länger als die Toleranz ertönt ein sanfter Ton (und der Bildschirm blinkt).</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="grid3"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="stat"&gt;&lt;div class="v" id="statusTxt"&gt;Warte…&lt;/div&gt;&lt;div class="muted"&gt;Status&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="stat"&gt;&lt;div class="v" id="cycleLen"&gt;–&lt;/div&gt;&lt;div class="muted"&gt;Soll Zykluslänge&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="stat"&gt;&lt;div class="v" id="lastPeriod"&gt;–&lt;/div&gt;&lt;div class="muted"&gt;Ist Zyklus (s)&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="stat"&gt;&lt;div class="v" id="devPct"&gt;–&lt;/div&gt;&lt;div class="muted"&gt;Abweichung&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="row" style="align-items:center;margin-top:10px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill"&gt;&lt;span class="led ok" id="led"&gt;&lt;/span&gt;&lt;span id="ledTxt"&gt;ruhig&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="muted"&gt;Signalqualität: &lt;span id="sigQ"&gt;—&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="muted" style="margin-bottom:6px;"&gt;Debug (optional)&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="log" id="log"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="muted" style="font-size:.8rem;margin-top:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>Hinweis: Kein Medizinprodukt. Funktioniert am besten mit deaktivierter Auto-Sperre oder aktivem Wake-Lock. Safari benötigt</p>
<p class="p1"><span class="Apple-converted-space">    </span>vorherigen Tipp auf „Sensor-Freigabe“ und „Audio aktivieren“.</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- UI elements ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>const els = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>pattern: document.getElementById('pattern'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>custom: document.getElementById('custom'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>tolerance: document.getElementById('tolerance'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>deviation: document.getElementById('deviation'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>sensitivity: document.getElementById('sensitivity'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>volume: document.getElementById('volume'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>tolLabel: document.getElementById('tolLabel'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>devLabel: document.getElementById('devLabel'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>permBtn: document.getElementById('perm'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>soundBtn: document.getElementById('sound'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>wakeBtn: document.getElementById('wake'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>startBtn: document.getElementById('start'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>stopBtn: document.getElementById('stop'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>calibrateBtn: document.getElementById('calibrate'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>statusTxt: document.getElementById('statusTxt'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>cycTxt: document.getElementById('cycleLen'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastPeriod: document.getElementById('lastPeriod'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>devPct: document.getElementById('devPct'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>led: document.getElementById('led'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>ledTxt: document.getElementById('ledTxt'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>sigQ: document.getElementById('sigQ'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>log: document.getElementById('log'),</p>
<p class="p1"><span class="Apple-converted-space">    </span>body: document.body</p>
<p class="p1"><span class="Apple-converted-space">  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- State ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>let audioCtx = null, alarmNode = null, alarmGain = null;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let wakeLock = null;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let running = false, calibrated = false;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastPeakTime = 0, periods = [];</p>
<p class="p1"><span class="Apple-converted-space">  </span>let strongDevSince = null;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let ema = 0, ema2 = 0, alphaBase = 0.08; // smoothing</p>
<p class="p1"><span class="Apple-converted-space">  </span>let minPeakDistance = 3.0; // seconds (avoid double peaks)</p>
<p class="p1"><span class="Apple-converted-space">  </span>let minAmplitude = 0.002; // dynamic, scaled by sensitivity</p>
<p class="p1"><span class="Apple-converted-space">  </span>let quality = 0; // 0..1</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Helpers ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>const log = (s)=&gt; { els.log.textContent = (s + "\n" + els.log.textContent).slice(0,4000); };</p>
<p class="p1"><span class="Apple-converted-space">  </span>const clamp = (v,a,b)=&gt; Math.max(a, Math.min(b, v));</p>
<p class="p1"><span class="Apple-converted-space">  </span>const now = ()=&gt; performance.now()/1000;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function parsePattern(str) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const parts = str.split('-').map(x=&gt;parseFloat(x||'0'));</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (parts.length!==4 || parts.some(isNaN)) return [4,4,4,4];</p>
<p class="p1"><span class="Apple-converted-space">    </span>return parts;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function cycleSeconds() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const pat = (els.pattern.value==='custom') ? parsePattern(els.custom.value) : parsePattern(els.pattern.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return pat.reduce((a,b)=&gt;a+b,0);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function setLed(state) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.led.className='led ' + (state==='ok'?'ok':state==='warn'?'warn':'bad');</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.ledTxt.textContent = state==='ok'?'ruhig':state==='warn'?'abweichend':'alarmbereit';</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function updateUI() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.tolLabel.textContent = (+els.tolerance.value).toFixed(1);</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.devLabel.textContent = Math.round(+els.deviation.value*100);</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.cycTxt.textContent = cycleSeconds().toFixed(1) + ' s';</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>updateUI();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Enable/disable custom input</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.pattern.addEventListener('change', ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>const cust = (els.pattern.value==='custom');</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.custom.disabled = !cust;</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateUI();</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.custom.addEventListener('input', updateUI);</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.tolerance.addEventListener('input', updateUI);</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.deviation.addEventListener('input', updateUI);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Permissions ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>async function requestMotionPermission() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (typeof DeviceMotionEvent !== 'undefined' &amp;&amp;</p>
<p class="p1"><span class="Apple-converted-space">          </span>typeof DeviceMotionEvent.requestPermission === 'function') {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const res = await DeviceMotionEvent.requestPermission();</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (res !== 'granted') throw new Error('abgelehnt');</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>els.permBtn.textContent = '<span class="s1">✅</span> Sensor bereit';</p>
<p class="p1"><span class="Apple-converted-space">      </span>els.permBtn.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">      </span>return true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch(e) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>alert('Bewegungssensor nicht freigegeben. Bitte in Safari erlauben.');</p>
<p class="p1"><span class="Apple-converted-space">      </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Audio ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>function ensureAudio() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!audioCtx) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>audioCtx = new (window.AudioContext || window.webkitAudioContext)();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (audioCtx.state === 'suspended') audioCtx.resume();</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!alarmGain) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>alarmGain = audioCtx.createGain(); alarmGain.gain.value = 0.0001;</p>
<p class="p1"><span class="Apple-converted-space">      </span>alarmNode = audioCtx.createOscillator(); alarmNode.type = 'sine'; alarmNode.frequency.value = 530;</p>
<p class="p1"><span class="Apple-converted-space">      </span>alarmNode.connect(alarmGain).connect(audioCtx.destination);</p>
<p class="p1"><span class="Apple-converted-space">      </span>alarmNode.start();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.soundBtn.textContent = '<span class="s1">✅</span> Audio bereit';</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.soundBtn.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function playAlarm(on) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!alarmGain) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const vol = parseFloat(els.volume.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (on) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// gentle attack</p>
<p class="p1"><span class="Apple-converted-space">      </span>const g = alarmGain.gain;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const t = audioCtx.currentTime;</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.cancelScheduledValues(t);</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.setValueAtTime(g.value, t);</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.linearRampToValueAtTime(vol*0.4, t+0.4);</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.linearRampToValueAtTime(vol, t+1.2);</p>
<p class="p1"><span class="Apple-converted-space">      </span>els.body.classList.add('blink');</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const g = alarmGain.gain;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const t = audioCtx.currentTime;</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.cancelScheduledValues(t);</p>
<p class="p1"><span class="Apple-converted-space">      </span>g.linearRampToValueAtTime(0.0001, t+0.25);</p>
<p class="p1"><span class="Apple-converted-space">      </span>els.body.classList.remove('blink');</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Wake Lock (if available) ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>async function toggleWakeLock() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>if ('wakeLock' in navigator) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!wakeLock) wakeLock = await navigator.wakeLock.request('screen');</p>
<p class="p1"><span class="Apple-converted-space">        </span>wakeLock.addEventListener('release', ()=&gt;{ wakeLock=null; els.wakeBtn.textContent='<span class="s1">🌙</span> Bildschirm wach halten';});</p>
<p class="p1"><span class="Apple-converted-space">        </span>els.wakeBtn.textContent = '<span class="s1">✅</span> Bildschirm bleibt an';</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>alert('Kein Wake-Lock verfügbar. Bitte in iOS die Auto-Sperre temporär deaktivieren (Einstellungen <span class="s1">▶️</span> Anzeige &amp; Helligkeit <span class="s1">▶️</span> Automatische Sperre <span class="s1">▶️</span> Nie).');</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch(e) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.warn(e);</p>
<p class="p1"><span class="Apple-converted-space">      </span>alert('Wake-Lock fehlgeschlagen. Bitte Auto-Sperre manuell deaktivieren.');</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>els.permBtn.addEventListener('click', requestMotionPermission);</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.soundBtn.addEventListener('click', ensureAudio);</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.wakeBtn.addEventListener('click', toggleWakeLock);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Calibration ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>function doCalibrate() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>ema = 0; ema2=0; periods.length=0; lastPeakTime=0; strongDevSince=null; quality=0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>calibrated = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>setLed('ok');</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.statusTxt.textContent = 'Kalibriert';</p>
<p class="p1"><span class="Apple-converted-space">    </span>log('Kalibriert – atme im Muster, dann Start.');</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.calibrateBtn.addEventListener('click', doCalibrate);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Breathing detection ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastT = null, lastVal = 0, rising = false;</p>
<p class="p1"><span class="Apple-converted-space">  </span>function resetDetection() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastT = null; lastVal = 0; rising = false; lastPeakTime = 0; periods.length=0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>strongDevSince=null; quality=0; playAlarm(false);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function onMotion(ev) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!running) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const t = now();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const a = ev.accelerationIncludingGravity || ev.acceleration || {x:0,y:0,z:0};</p>
<p class="p1"><span class="Apple-converted-space">    </span>const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Exponential moving averages to smooth breathing-scale motion</p>
<p class="p1"><span class="Apple-converted-space">    </span>// alpha scaled by frame rate and sensitivity</p>
<p class="p1"><span class="Apple-converted-space">    </span>const sens = parseFloat(els.sensitivity.value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const alpha = clamp(alphaBase * sens, 0.02, 0.5);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ema = (1-alpha)*ema + alpha*mag;</p>
<p class="p1"><span class="Apple-converted-space">    </span>ema2 = (1-alpha/3)*ema2 + (alpha/3)*ema;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const s = ema - ema2; // a simple band-pass-ish signal</p>
<p class="p1"><span class="Apple-converted-space">    </span>const tSec = t;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Peak detection</p>
<p class="p1"><span class="Apple-converted-space">    </span>const delta = s - lastVal;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const isRising = delta &gt; 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const minA = minAmplitude / sens;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!rising &amp;&amp; isRising) rising = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const dtFromLastPeak = lastPeakTime ? (tSec - lastPeakTime) : Infinity;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// simple local maxima</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (rising &amp;&amp; !isRising &amp;&amp; lastVal &gt; minA &amp;&amp; dtFromLastPeak &gt; minPeakDistance) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const nowPeak = tSec;</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (lastPeakTime&gt;0) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const period = nowPeak - lastPeakTime;</p>
<p class="p1"><span class="Apple-converted-space">        </span>periods.push(period);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (periods.length&gt;6) periods.shift();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const avgPeriod = periods.reduce((a,b)=&gt;a+b,0) / periods.length;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const target = cycleSeconds();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dev = Math.abs(avgPeriod - target) / target;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const devPct = Math.round(dev*100);</p>
<p class="p1"><span class="Apple-converted-space">        </span>els.lastPeriod.textContent = avgPeriod.toFixed(1) + ' s';</p>
<p class="p1"><span class="Apple-converted-space">        </span>els.devPct.textContent = devPct + ' %';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Signal quality heuristic: amplitude and consistency</p>
<p class="p1"><span class="Apple-converted-space">        </span>const ampScore = clamp((lastVal - minA) * 100, 0, 1);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const varScore = clamp(1 - (stdev(periods)/target), 0, 1);</p>
<p class="p1"><span class="Apple-converted-space">        </span>quality = clamp(0.3*ampScore + 0.7*varScore, 0, 1);</p>
<p class="p1"><span class="Apple-converted-space">        </span>els.sigQ.textContent = (quality*100|0) + '%';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Deviation handling with tolerance window</p>
<p class="p1"><span class="Apple-converted-space">        </span>const strong = dev &gt;= parseFloat(els.deviation.value);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (strong) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (!strongDevSince) strongDevSince = tSec;</p>
<p class="p1"><span class="Apple-converted-space">          </span>setLed('warn');</p>
<p class="p1"><span class="Apple-converted-space">          </span>els.statusTxt.textContent = 'abweichend…';</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (tSec - strongDevSince &gt;= parseFloat(els.tolerance.value)) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>setLed('bad'); els.statusTxt.textContent = 'sanfter Alarm';</p>
<p class="p1"><span class="Apple-converted-space">            </span>playAlarm(true);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>strongDevSince = null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>setLed('ok'); els.statusTxt.textContent = 'im Takt';</p>
<p class="p1"><span class="Apple-converted-space">          </span>playAlarm(false);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>lastPeakTime = nowPeak;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastVal = s;</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastT = tSec;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function stdev(arr) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (arr.length&lt;2) return 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const m = arr.reduce((a,b)=&gt;a+b,0)/arr.length;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const v = arr.reduce((a,b)=&gt;a+(b-m)*(b-m),0)/(arr.length-1);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return Math.sqrt(v);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// --- Start/Stop ---</p>
<p class="p1"><span class="Apple-converted-space">  </span>function start() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!calibrated) doCalibrate();</p>
<p class="p1"><span class="Apple-converted-space">    </span>resetDetection();</p>
<p class="p1"><span class="Apple-converted-space">    </span>running = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>window.addEventListener('devicemotion', onMotion, { capture:false, passive:true });</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.statusTxt.textContent = 'läuft…';</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.cycTxt.textContent = cycleSeconds().toFixed(1) + ' s';</p>
<p class="p1"><span class="Apple-converted-space">    </span>log('Session gestartet.');</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function stop() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>running = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>window.removeEventListener('devicemotion', onMotion, { capture:false });</p>
<p class="p1"><span class="Apple-converted-space">    </span>playAlarm(false);</p>
<p class="p1"><span class="Apple-converted-space">    </span>els.statusTxt.textContent = 'gestoppt';</p>
<p class="p1"><span class="Apple-converted-space">    </span>setLed('ok');</p>
<p class="p1"><span class="Apple-converted-space">    </span>log('Session gestoppt.');</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.startBtn.addEventListener('click', start);</p>
<p class="p1"><span class="Apple-converted-space">  </span>els.stopBtn.addEventListener('click', stop);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Friendly initial text</p>
<p class="p1"><span class="Apple-converted-space">  </span>setLed('ok'); els.statusTxt.textContent = 'bereit';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// iOS: resume audio on any touch if user forgot the button</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.addEventListener('touchstart', ()=&gt;{ if (audioCtx &amp;&amp; audioCtx.state==='suspended') audioCtx.resume(); }, {passive:true});</p>
<p class="p1">})();</p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
